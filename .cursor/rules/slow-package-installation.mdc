# 慢速包安装处理规则

## 核心规则

**当需要安装 npm/package 依赖包时，如果检测到安装速度较慢，应让用户自行安装。**

## 判断标准

以下情况视为"安装速度较慢"：

1. **网络环境限制**：
   - 检测到用户使用国内网络环境
   - 默认 npm registry 访问缓慢
   - 需要代理或特殊网络配置

2. **包体积较大**：
   - 安装包包含大量二进制文件（如 `sharp`、`puppeteer`）
   - 需要编译原生模块（如 `node-gyp` 依赖）
   - 包依赖树复杂，安装时间超过 1 分钟

3. **系统资源限制**：
   - 用户设备性能较低
   - 磁盘 I/O 速度较慢
   - 内存不足导致安装缓慢

## 操作流程

### 1. 预先评估

在建议用户安装包之前，先评估：
- 包的大小和复杂度
- 是否需要编译或下载二进制文件
- 是否是常见的"慢安装"包

### 2. 提供选项

如果发现可能安装缓慢，应该：

```
检测到包 [package-name] 可能安装较慢（原因：xxx）。

您可以选择：
1. 我现在为您安装（可能需要较长时间）
2. 您自行安装：bun add [package-name]
3. 跳过安装，继续其他任务
```

### 3. 已知慢安装包列表

以下包通常安装较慢，应主动提示用户：

**需要编译/下载二进制的包**：
- `sharp` - 图片处理，需要下载平台特定的二进制文件
- `puppeteer` / `playwright` - 需要下载 Chromium
- `canvas` - 需要编译 Cairo 等系统依赖
- `node-sass` / `sass` - 需要编译原生模块
- `bcrypt` - 需要编译原生加密模块

**大型包或复杂依赖树**：
- `@tensorflow/tfjs` - 机器学习库，体积大
- `prisma` - 需要生成客户端
- `next` / `react` 生态系统的完整安装

### 4. 提供加速建议

如果用户选择自行安装，提供加速建议：

```bash
# 使用 Bun（通常更快）
bun add package-name

# 使用国内镜像（如果适用）
bun config set registry https://registry.npmmirror.com

# 清除缓存后重新安装
bun cache clean && bun add package-name
```

## 例外情况

以下情况可以自动安装：

1. **小型纯 JavaScript 包**：依赖少，体积小，通常安装快速
2. **项目初始化必需包**：用户明确要求创建项目时
3. **用户明确要求立即安装**：用户清楚安装时间并坚持要安装
4. **已缓存的包**：包已经在本地缓存中

## 沟通模板

### 发现慢安装包时

```
⚠️ 检测到需要安装 `package-name`，这个包通常安装较慢（原因：需要下载二进制文件/编译原生模块）。

建议您：
1. 自行运行：`bun add package-name`
2. 如果网络较慢，可以先切换镜像：`bun config set registry https://registry.npmmirror.com`
3. 或者我现在为您安装（可能需要 2-5 分钟）

您希望我继续吗？
```

### 用户选择等待时

```
好的，我正在为您安装 `package-name`...

💡 提示：安装正在进行中，这可能需要几分钟时间。
   - 如果需要下载二进制文件，速度取决于网络状况
   - 编译过程会使用 CPU 资源
   - 您可以在终端查看实时进度
```

## 注意事项

1. **不要自动重试**：如果安装失败，不要自动重试，先询问用户
2. **提供替代方案**：如果有更轻量的替代包，应该推荐
3. **记录安装时间**：对于经常安装的包，记录预计安装时间供参考
4. **考虑平台差异**：macOS、Linux、Windows 的安装速度可能不同

## 示例场景

### 场景 1：图片处理功能

```
用户：我想添加图片压缩功能

助手：好的，我建议使用 `sharp` 库来实现图片压缩。

⚠️ 注意：`sharp` 需要下载平台特定的二进制文件，安装可能较慢（通常 2-5 分钟，取决于网络）。

您可以：
1. 自行安装：`bun add sharp`
2. 使用国内镜像加速：
   ```bash
   bun config set registry https://registry.npmmirror.com
   bun add sharp
   ```
3. 或者我现在为您安装

您希望怎么做？
```

### 场景 2：浏览器自动化

```
用户：我需要一个浏览器自动化工具

助手：推荐使用 `playwright`，它比 Puppeteer 更现代且功能更强大。

⚠️ 注意：`playwright` 需要下载 Chromium 浏览器（约 100MB），初次安装较慢。

建议安装步骤：
```bash
# 1. 安装包
bun add playwright

# 2. 下载浏览器（可以选择只下载需要的浏览器）
bun x playwright install chromium
```

您想现在安装吗？还是稍后自行安装？
```

## 实施要求

- 在建议安装包之前，先检查是否是已知慢安装包
- 对于不确定的包，可以搜索或查询包信息来判断
- 始终给用户选择权，不要默认开始慢速安装
- 提供清晰的安装时间预期
